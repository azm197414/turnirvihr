<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Турнирная таблица клуба "Вихрь"</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f5f5f5;
            padding: 20px;
            margin: 0;
        }
        .container {
            max-width: 95vw;
            margin: 0 auto;
            overflow-x: auto;
        }
        .tournament-table {
            border-collapse: collapse;
            background-color: white;
            box-shadow: 0 0 10px rgba(0,0,0,0.1);
            margin-bottom: 20px;
            font-size: 0.85em;
            min-width: 1400px;
            border: 2px solid #2c3e50;
        }
        .tournament-table th, .tournament-table td {
            border: 2px solid #95a5a6;
            padding: 6px 8px;
            text-align: center;
            vertical-align: middle;
            min-width: 70px;
        }
        .tournament-table th {
            background-color: #2c3e50;
            color: white;
            font-weight: bold;
            border: 2px solid #34495e;
        }
        .input-cell {
            background-color: #fff;
        }
        .input-cell input {
            width: 90%;
            padding: 4px;
            border: 1px solid #ddd;
            border-radius: 3px;
            text-align: center;
            font-size: 0.9em;
        }
        .result-cell {
            background-color: #e8f4fd;
            font-weight: bold;
            color: #2c3e50;
        }
        .team-header {
            background-color: #ecf0f1;
            font-weight: bold;
        }
        .participant-row {
            background-color: #f8f9fa;
        }
        .controls {
            background-color: #fff;
            padding: 15px;
            border-radius: 5px;
            box-shadow: 0 0 5px rgba(0,0,0,0.1);
            margin-bottom: 20px;
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }
        .controls button {
            background-color: #3498db;
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 3px;
            cursor: pointer;
            font-size: 0.9em;
            font-weight: bold;
        }
        .controls button:hover {
            background-color: #2980b9;
        }
        .controls button.reset {
            background-color: #e74c3c;
        }
        .controls button.reset:hover {
            background-color: #c0392b;
        }
        .controls button.test {
            background-color: #2ecc71;
        }
        .controls button.test:hover {
            background-color: #27ae60;
        }
        .controls button.export {
            background-color: #9b59b6;
        }
        .controls button.export:hover {
            background-color: #8e44ad;
        }
        .notes {
            font-size: 0.9em;
            color: #7f8c8d;
            margin-top: 10px;
            padding: 10px;
            background-color: #ecf0f1;
            border-left: 4px solid #3498db;
        }
        .time-input {
            font-family: monospace;
            font-size: 0.85em;
        }
        .calculated-cell {
            background-color: #e8f6f3;
            font-weight: bold;
        }
        .personal-score {
            background-color: #d5f4e6;
            font-weight: bold;
        }
        .team-score {
            background-color: #fef9e7;
            font-weight: bold;
            font-size: 1.1em;
        }
        .error-cell {
            background-color: #fadbd8;
            color: #c0392b;
            font-weight: bold;
        }
        .formula-note {
            font-size: 0.75em;
            color: #7f8c8d;
            font-style: italic;
        }
        .participant-name {
            white-space: nowrap;
            text-align: left;
            padding-left: 10px;
            font-weight: bold;
        }
        .team-name {
            font-weight: bold;
            font-size: 1em;
        }
        .header-name {
            font-weight: bold;
        }
        .main-title {
            background-color: #2c3e50;
            color: white;
            padding: 15px;
            text-align: center;
            font-size: 1.3em;
            font-weight: bold;
            margin-bottom: 20px;
            border-radius: 5px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        .max-min-cell {
            background-color: #d6dbdf;
            font-weight: bold;
        }
        
        /* Стили защиты */
        .protected {
            user-select: none;
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
        }
        .warning-message {
            display: none;
            position: fixed;
            top: 20px;
            right: 20px;
            background: #e74c3c;
            color: white;
            padding: 15px;
            border-radius: 5px;
            z-index: 10000;
            font-weight: bold;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            animation: fadeIn 0.3s;
        }
        
        /* Стили для формы пароля */
        .password-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(44, 62, 80, 0.95);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 9999;
        }
        .password-form {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
            text-align: center;
            min-width: 300px;
        }
        .password-form h2 {
            color: #2c3e50;
            margin-bottom: 20px;
        }
        .password-input {
            width: 100%;
            padding: 12px;
            margin: 15px 0;
            border: 2px solid #3498db;
            border-radius: 5px;
            font-size: 16px;
            text-align: center;
            letter-spacing: 2px;
        }
        .password-input:focus {
            outline: none;
            border-color: #2980b9;
            box-shadow: 0 0 5px rgba(52, 152, 219, 0.5);
        }
        .password-submit {
            background: #3498db;
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: 5px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            width: 100%;
            transition: background 0.3s;
        }
        .password-submit:hover {
            background: #2980b9;
        }
        .password-error {
            color: #e74c3c;
            margin-top: 10px;
            font-size: 14px;
            display: none;
        }
        .password-hint {
            color: #7f8c8d;
            font-size: 12px;
            margin-top: 15px;
            font-style: italic;
        }
        
        /* Блокировка интерфейса */
        .locked {
            opacity: 0.3;
            pointer-events: none;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        @keyframes fadeOut {
            from { opacity: 1; transform: translateY(0); }
            to { opacity: 0; transform: translateY(-20px); }
        }
    </style>
</head>
<body>
    <!-- Форма ввода пароля -->
    <div id="passwordOverlay" class="password-overlay">
        <div class="password-form">
            <h2>ДОСТУП К ТУРНИРНОЙ ТАБЛИЦЕ</h2>
            <p>Для работы с таблицей введите пароль:</p>
            <input type="password" id="passwordInput" class="password-input" placeholder="Введите пароль" autocomplete="off">
            <div id="passwordError" class="password-error">Неверный пароль. Попробуйте снова.</div>
            <button id="passwordSubmit" class="password-submit">Войти</button>
            <div class="password-hint">Пароль предоставляет организатор турнира</div>
        </div>
    </div>
    
    <!-- Основной контент (изначально скрыт) -->
    <div id="mainContent" class="container" style="display: none;">
        <div class="main-title">
            ТАБЛИЦА БОЛЬШОГО ЗИМНЕГО ТУРНИРА КЛУБА ПИЛОТОВ БПЛА "ВИХРЬ"
        </div>
        
        <div class="controls">
            <button onclick="calculateAll()">Пересчитать все</button>
            <button onclick="resetAll()" class="reset">Сбросить все данные</button>
            <button onclick="fillTestData()" class="test">Заполнить тестовые данные</button>
            <button onclick="exportToExcel()" class="export">Экспорт в CSV</button>
            <button onclick="logout()" class="reset" style="margin-left: auto;">Выйти</button>
        </div>
        
        <table class="tournament-table" id="tournamentTable">
            <!-- Основные заголовки -->
            <tr>
                <th rowspan="3" class="header-name">Команда</th>
                <th rowspan="3" class="header-name">Участник</th>
                <th colspan="3" class="header-name">Литофф</th>
                <th colspan="2" class="header-name">Квадросим</th>
                <th colspan="3" class="header-name">Трасса</th>
                <th rowspan="3" class="header-name">Баллы ЛЗ</th>
                <th rowspan="3" class="header-name">Баллы КЗ</th>
            </tr>
            
            <tr>
                <!-- Литофф подзаголовки -->
                <th class="header-name">Угол</th>
                <th class="header-name">Время (ММ:СС:МС)</th>
                <th class="header-name">Баллы</th>
                <!-- Квадросим подзаголовки -->
                <th class="header-name">Время (ММ:СС:МС)</th>
                <th class="header-name">Баллы</th>
                <!-- Трасса подзаголовки -->
                <th class="header-name">Кол-во кругов</th>
                <th class="header-name">Штраф</th>
                <th class="header-name">Баллы</th>
            </tr>
            
            <tr class="max-min-cell">
                <!-- Литофф формулы для максимума/минимума -->
                <td>Максимум<br><span id="maxAngle">0</span></td>
                <td>Минимум<br><span id="minTimeLz">00:00:00</span></td>
                <td>Максимум<br><span id="maxScoreLz">0.00</span></td>
                <!-- Квадросим формулы для минимума -->
                <td>Минимум<br><span id="minTimeKz">00:00:00</span></td>
                <td>Максимум<br><span id="maxScoreKz">0.00</span></td>
                <!-- Трасса формулы для максимума/минимума -->
                <td>Максимум<br><span id="maxLaps">0</span></td>
                <td>Минимум<br><span id="minPenalty">0</span></td>
                <td>Максимум<br><span id="maxScoreTrack">0.00</span></td>
                <!-- Пустые для выравнивания -->
                <td></td>
                <td></td>
            </tr>
            
            <!-- Данные участников будут заполняться JavaScript -->
        </table>
        
        <div class="notes">
            <p><strong>Формулы расчетов:</strong></p>
            <ul>
                <li><strong>Баллы Литофф:</strong> = (Угол/МАКС_Угол * 70) + (МИН_Время_ЛЗ/Время_ЛЗ * 30)</li>
                <li><strong>Баллы Квадросим:</strong> = (МИН_Время_КЗ * 100) / Время_КЗ</li>
                <li><strong>Баллы Трассы:</strong> = (Круги/МАКС_Круги * 100) - Штраф</li>
                <li><strong>Баллы ЛЗ (личный зачет):</strong> = Баллы_Литофф + Баллы_Квадросим + Баллы_Трассы</li>
                <li><strong>Баллы КЗ (командный зачет):</strong> = Сумма Баллов_ЛЗ обоих участников команды (одна ячейка на команду)</li>
                <li><strong>ОЖИДАНИЕ:</strong> показывается при отсутствии данных или делении на ноль</li>
            </ul>
        </div>
    </div>

    <div id="warningMessage" class="warning-message"></div>

    <script>
        // ========== СИСТЕМА ПАРОЛЯ ==========
        
        // Пароль для доступа (можно изменить)
        const ACCESS_PASSWORD = "ASDF2025"; // Замените на свой пароль
        
        // Ключи для localStorage
        const STORAGE_KEYS = {
            PASSWORD: 'турнир_пароль',
            DATA: 'турнир_данные',
            SESSION: 'турнир_сессия'
        };
        
        // Проверка авторизации
        function checkAuth() {
            const session = localStorage.getItem(STORAGE_KEYS.SESSION);
            const savedPassword = localStorage.getItem(STORAGE_KEYS.PASSWORD);
            
            // Если есть активная сессия или сохраненный пароль
            if (session === 'active' || savedPassword === hashPassword(ACCESS_PASSWORD)) {
                showMainContent();
                return true;
            }
            return false;
        }
        
        // Хеширование пароля (простое)
        function hashPassword(password) {
            return btoa(encodeURIComponent(password + 'salt_вихрь'));
        }
        
        // Показать основное содержимое
        function showMainContent() {
            document.getElementById('passwordOverlay').style.display = 'none';
            document.getElementById('mainContent').style.display = 'block';
            // Установить активную сессию
            localStorage.setItem(STORAGE_KEYS.SESSION, 'active');
            // Сохранить пароль для будущих сессий
            localStorage.setItem(STORAGE_KEYS.PASSWORD, hashPassword(ACCESS_PASSWORD));
            // Инициализировать таблицу
            initTable();
        }
        
        // Вход по паролю
        function login() {
            const passwordInput = document.getElementById('passwordInput');
            const passwordError = document.getElementById('passwordError');
            const enteredPassword = passwordInput.value.trim();
            
            if (enteredPassword === ACCESS_PASSWORD) {
                passwordError.style.display = 'none';
                passwordInput.value = '';
                showMainContent();
            } else {
                passwordError.style.display = 'block';
                passwordInput.value = '';
                passwordInput.focus();
                // Вибрация при ошибке (если поддерживается)
                if (navigator.vibrate) {
                    navigator.vibrate(200);
                }
            }
        }
        
        // Выход
        function logout() {
            if (confirm('Вы уверены, что хотите выйти? Данные будут сохранены.')) {
                localStorage.removeItem(STORAGE_KEYS.SESSION);
                document.getElementById('mainContent').style.display = 'none';
                document.getElementById('passwordOverlay').style.display = 'flex';
                document.getElementById('passwordInput').focus();
            }
        }
        
        // Автовыход через 8 часов
        setTimeout(() => {
            if (localStorage.getItem(STORAGE_KEYS.SESSION) === 'active') {
                localStorage.removeItem(STORAGE_KEYS.SESSION);
                alert('Сессия истекла. Пожалуйста, войдите снова.');
                location.reload();
            }
        }, 8 * 60 * 60 * 1000); // 8 часов
        
        // ========== ИНИЦИАЛИЗАЦИЯ ==========
        
        document.addEventListener('DOMContentLoaded', function() {
            // Настроить обработчики для формы пароля
            document.getElementById('passwordSubmit').addEventListener('click', login);
            document.getElementById('passwordInput').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    login();
                }
            });
            
            // Фокус на поле пароля при загрузке
            document.getElementById('passwordInput').focus();
            
            // Проверить авторизацию
            if (!checkAuth()) {
                // Показать форму пароля
                document.getElementById('passwordOverlay').style.display = 'flex';
            }
            
            // Защита от DevTools
            initProtection();
        });
        
        // ========== ЗАЩИТА ОТ ИЗМЕНЕНИЙ ==========
        
        function initProtection() {
            // 1. Запретить контекстное меню
            document.addEventListener('contextmenu', function(e) {
                e.preventDefault();
                showWarning('Правый клик отключен. Используйте кнопки управления.');
                return false;
            });
            
            // 2. Запретить горячие клавиши разработчика
            document.addEventListener('keydown', function(e) {
                if (e.keyCode === 123 || // F12
                    (e.ctrlKey && e.shiftKey && (e.keyCode === 73 || e.keyCode === 74 || e.keyCode === 67)) || // Ctrl+Shift+I/J/C
                    (e.ctrlKey && e.keyCode === 85)) { // Ctrl+U
                    e.preventDefault();
                    showWarning('Горячие клавиши разработчика отключены!');
                    return false;
                }
            });
            
            // 3. Сообщение в консоли
            console.log('%c ⚠️ ДОСТУП ОГРАНИЧЕН ⚠️ ', 'color: red; font-size: 24px; font-weight: bold;');
            console.log('%c Изменение кода таблицы запрещено! ', 'color: white; background: red; font-size: 16px;');
            console.log('%c Используйте только поля ввода для изменения данных. ', 'color: #2c3e50; font-size: 14px;');
        }
        
        function showWarning(message) {
            const warning = document.getElementById('warningMessage');
            warning.textContent = message;
            warning.style.display = 'block';
            
            setTimeout(() => {
                warning.style.animation = 'fadeOut 0.3s';
                setTimeout(() => {
                    warning.style.display = 'none';
                    warning.style.animation = '';
                }, 300);
            }, 3000);
        }
        
        // ========== ДАННЫЕ И ЛОГИКА ТАБЛИЦЫ ==========
        
        const participants = [
            { team: "Интенсив", name: "Ксения Л.", id: 1, teamIndex: 0 },
            { team: "Интенсив", name: "Святослав Е.", id: 2, teamIndex: 0 },
            { team: "Прорыв", name: "Никита У.", id: 3, teamIndex: 1 },
            { team: "Прорыв", name: "Варя А.", id: 4, teamIndex: 1 },
            { team: "Альфа", name: "Дмитрий В.", id: 5, teamIndex: 2 },
            { team: "Альфа", name: "Иван Ф.", id: 6, teamIndex: 2 },
            { team: "Стабильность", name: "Савелий С.", id: 7, teamIndex: 3 },
            { team: "Стабильность", name: "Богдан Е.", id: 8, teamIndex: 3 },
            { team: "Мотивация", name: "Артем П.", id: 9, teamIndex: 4 },
            { team: "Мотивация", name: "Данила Л.", id: 10, teamIndex: 4 }
        ];
        
        function initTable() {
            createTable();
            loadFromLocalStorage();
            protectElements();
        }
        
        function createTable() {
            const table = document.getElementById('tournamentTable');
            
            while (table.rows.length > 3) {
                table.deleteRow(3);
            }
            
            participants.forEach((participant, index) => {
                const row = table.insertRow();
                const isFirstInTeam = index === 0 || participants[index-1].team !== participant.team;
                
                if (isFirstInTeam) {
                    row.className = 'team-header';
                } else {
                    row.className = 'participant-row';
                }
                
                if (isFirstInTeam) {
                    row.innerHTML = `
                        <td rowspan="2" class="team-name">"${participant.team}"</td>
                        <td class="participant-name">${participant.name}</td>
                        <td class="input-cell"><input type="number" id="angle_${index}" min="0" max="90" value="0" step="1" placeholder="0-90°"></td>
                        <td class="input-cell"><input type="text" id="time_lz_${index}" class="time-input" placeholder="ММ:СС:МС" value="00:00:00"></td>
                        <td class="result-cell" id="score_lz_${index}">ОЖИДАНИЕ</td>
                        <td class="input-cell"><input type="text" id="time_kz_${index}" class="time-input" placeholder="ММ:СС:МС" value="00:00:00"></td>
                        <td class="result-cell" id="score_kz_${index}">ОЖИДАНИЕ</td>
                        <td class="input-cell"><input type="number" id="laps_${index}" min="0" value="0" placeholder="0+"></td>
                        <td class="input-cell"><input type="number" id="penalty_${index}" min="0" value="0" placeholder="0+"></td>
                        <td class="result-cell" id="score_track_${index}">ОЖИДАНИЕ</td>
                        <td class="personal-score" id="personal_score_${index}">ОЖИДАНИЕ</td>
                        <td rowspan="2" class="team-score" id="team_score_${participant.teamIndex}">ОЖИДАНИЕ</td>
                    `;
                } else {
                    row.innerHTML = `
                        <td class="participant-name">${participant.name}</td>
                        <td class="input-cell"><input type="number" id="angle_${index}" min="0" max="90" value="0" step="1" placeholder="0-90°"></td>
                        <td class="input-cell"><input type="text" id="time_lz_${index}" class="time-input" placeholder="ММ:СС:МС" value="00:00:00"></td>
                        <td class="result-cell" id="score_lz_${index}">ОЖИДАНИЕ</td>
                        <td class="input-cell"><input type="text" id="time_kz_${index}" class="time-input" placeholder="ММ:СС:МС" value="00:00:00"></td>
                        <td class="result-cell" id="score_kz_${index}">ОЖИДАНИЕ</td>
                        <td class="input-cell"><input type="number" id="laps_${index}" min="0" value="0" placeholder="0+"></td>
                        <td class="input-cell"><input type="number" id="penalty_${index}" min="0" value="0" placeholder="0+"></td>
                        <td class="result-cell" id="score_track_${index}">ОЖИДАНИЕ</td>
                        <td class="personal-score" id="personal_score_${index}">ОЖИДАНИЕ</td>
                    `;
                }
            });
            
            addInputEventListeners();
        }
        
        function addInputEventListeners() {
            for (let i = 0; i < participants.length; i++) {
                const inputs = [
                    `angle_${i}`, `time_lz_${i}`, `time_kz_${i}`, `laps_${i}`, `penalty_${i}`
                ];
                
                inputs.forEach(id => {
                    const input = document.getElementById(id);
                    if (input) {
                        input.addEventListener('input', () => {
                            calculateAll();
                            saveToLocalStorage();
                        });
                        
                        if (id.startsWith('time_')) {
                            input.addEventListener('blur', function() {
                                formatTimeInput(this);
                            });
                        }
                    }
                });
            }
        }
        
        function protectElements() {
            const elements = document.querySelectorAll(
                '.result-cell, .personal-score, .team-score, .calculated-cell, .max-min-cell, .header-name'
            );
            elements.forEach(el => {
                el.classList.add('protected');
            });
        }
        
        function formatTimeInput(input) {
            let value = input.value.trim();
            if (!value) {
                input.value = '00:00:00';
                return;
            }
            value = value.replace(/[^\d]/g, '');
            while (value.length < 6) value = '0' + value;
            value = value.substring(0, 6);
            const minutes = value.substring(0, 2);
            const seconds = value.substring(2, 4);
            const milliseconds = value.substring(4, 6);
            input.value = `${minutes}:${seconds}:${milliseconds}`;
        }
        
        function timeToSeconds(timeStr) {
            if (!timeStr || timeStr === '00:00:00') return 0;
            const parts = timeStr.split(':');
            if (parts.length !== 3) return 0;
            const minutes = parseInt(parts[0]) || 0;
            const seconds = parseInt(parts[1]) || 0;
            const milliseconds = parseInt(parts[2]) || 0;
            if (isNaN(minutes) || isNaN(seconds) || isNaN(milliseconds)) return 0;
            return minutes * 60 + seconds + (milliseconds / 100);
        }
        
        function secondsToTime(seconds) {
            if (seconds <= 0) return '00:00:00';
            const mins = Math.floor(seconds / 60);
            const secs = Math.floor(seconds % 60);
            const ms = Math.round((seconds - Math.floor(seconds)) * 100);
            return `${mins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}:${ms.toString().padStart(2, '0')}`;
        }
        
        function calculateAll() {
            const participantsData = [];
            
            for (let i = 0; i < participants.length; i++) {
                participantsData.push({
                    index: i,
                    angle: parseFloat(document.getElementById(`angle_${i}`).value) || 0,
                    timeLz: timeToSeconds(document.getElementById(`time_lz_${i}`).value),
                    timeKz: timeToSeconds(document.getElementById(`time_kz_${i}`).value),
                    laps: parseFloat(document.getElementById(`laps_${i}`).value) || 0,
                    penalty: parseFloat(document.getElementById(`penalty_${i}`).value) || 0,
                    teamIndex: participants[i].teamIndex
                });
            }
            
            const maxAngle = Math.max(...participantsData.filter(p => p.angle > 0).map(p => p.angle));
            const minTimeLz = Math.min(...participantsData.filter(p => p.timeLz > 0).map(p => p.timeLz));
            const minTimeKz = Math.min(...participantsData.filter(p => p.timeKz > 0).map(p => p.timeKz));
            const maxLaps = Math.max(...participantsData.filter(p => p.laps > 0).map(p => p.laps));
            const minPenalty = Math.min(...participantsData.filter(p => p.penalty > 0).map(p => p.penalty));
            
            document.getElementById('maxAngle').textContent = maxAngle > 0 ? maxAngle : '0';
            document.getElementById('minTimeLz').textContent = minTimeLz > 0 ? secondsToTime(minTimeLz) : '00:00:00';
            document.getElementById('minTimeKz').textContent = minTimeKz > 0 ? secondsToTime(minTimeKz) : '00:00:00';
            document.getElementById('maxLaps').textContent = maxLaps > 0 ? maxLaps : '0';
            document.getElementById('minPenalty').textContent = minPenalty > 0 ? minPenalty : '0';
            
            let maxScoreLz = 0, maxScoreKz = 0, maxScoreTrack = 0;
            
            participantsData.forEach(data => {
                const i = data.index;
                
                let scoreLz = "ОЖИДАНИЕ";
                if (maxAngle > 0 && data.angle > 0 && minTimeLz > 0 && data.timeLz > 0) {
                    const calculated = ((data.angle / maxAngle) * 70) + ((minTimeLz / data.timeLz) * 30);
                    scoreLz = calculated.toFixed(2);
                    maxScoreLz = Math.max(maxScoreLz, calculated);
                }
                
                let scoreKz = "ОЖИДАНИЕ";
                if (minTimeKz > 0 && data.timeKz > 0) {
                    const calculated = (minTimeKz * 100) / data.timeKz;
                    scoreKz = calculated.toFixed(2);
                    maxScoreKz = Math.max(maxScoreKz, calculated);
                }
                
                let scoreTrack = "ОЖИДАНИЕ";
                if (maxLaps > 0 && data.laps > 0) {
                    const calculated = ((data.laps / maxLaps) * 100) - data.penalty;
                    scoreTrack = calculated > 0 ? calculated.toFixed(2) : "0.00";
                    maxScoreTrack = Math.max(maxScoreTrack, calculated > 0 ? calculated : 0);
                }
                
                let personalScore = "ОЖИДАНИЕ";
                if (scoreLz !== "ОЖИДАНИЕ" && scoreKz !== "ОЖИДАНИЕ" && scoreTrack !== "ОЖИДАНИЕ") {
                    personalScore = (parseFloat(scoreLz) + parseFloat(scoreKz) + parseFloat(scoreTrack)).toFixed(2);
                }
                
                data.personalScore = personalScore === "ОЖИДАНИЕ" ? 0 : parseFloat(personalScore);
                
                document.getElementById(`score_lz_${i}`).textContent = scoreLz;
                document.getElementById(`score_lz_${i}`).className = scoreLz === "ОЖИДАНИЕ" ? "error-cell" : "result-cell";
                document.getElementById(`score_kz_${i}`).textContent = scoreKz;
                document.getElementById(`score_kz_${i}`).className = scoreKz === "ОЖИДАНИЕ" ? "error-cell" : "result-cell";
                document.getElementById(`score_track_${i}`).textContent = scoreTrack;
                document.getElementById(`score_track_${i}`).className = scoreTrack === "ОЖИДАНИЕ" ? "error-cell" : "result-cell";
                document.getElementById(`personal_score_${i}`).textContent = personalScore;
                document.getElementById(`personal_score_${i}`).className = personalScore === "ОЖИДАНИЕ" ? "error-cell" : "personal-score";
            });
            
            document.getElementById('maxScoreLz').textContent = maxScoreLz.toFixed(2);
            document.getElementById('maxScoreKz').textContent = maxScoreKz.toFixed(2);
            document.getElementById('maxScoreTrack').textContent = maxScoreTrack.toFixed(2);
            
            const teamScores = {};
            participantsData.forEach(data => {
                if (!teamScores[data.teamIndex]) teamScores[data.teamIndex] = 0;
                teamScores[data.teamIndex] += data.personalScore;
            });
            
            for (const [teamIndex, teamScore] of Object.entries(teamScores)) {
                document.getElementById(`team_score_${teamIndex}`).textContent = teamScore.toFixed(2);
                document.getElementById(`team_score_${teamIndex}`).className = "team-score";
            }
            
            for (let i = 0; i < 5; i++) {
                if (!teamScores[i]) {
                    document.getElementById(`team_score_${i}`).textContent = "ОЖИДАНИЕ";
                    document.getElementById(`team_score_${i}`).className = "error-cell";
                }
            }
        }
        
        function saveToLocalStorage() {
            const data = {};
            for (let i = 0; i < participants.length; i++) {
                data[`participant_${i}`] = {
                    angle: document.getElementById(`angle_${i}`).value,
                    timeLz: document.getElementById(`time_lz_${i}`).value,
                    timeKz: document.getElementById(`time_kz_${i}`).value,
                    laps: document.getElementById(`laps_${i}`).value,
                    penalty: document.getElementById(`penalty_${i}`).value
                };
            }
            localStorage.setItem(STORAGE_KEYS.DATA, JSON.stringify(data));
        }
        
        function loadFromLocalStorage() {
            const saved = localStorage.getItem(STORAGE_KEYS.DATA);
            if (saved) {
                try {
                    const data = JSON.parse(saved);
                    for (let i = 0; i < participants.length; i++) {
                        if (data[`participant_${i}`]) {
                            const p = data[`participant_${i}`];
                            document.getElementById(`angle_${i}`).value = p.angle || 0;
                            document.getElementById(`time_lz_${i}`).value = p.timeLz || '00:00:00';
                            document.getElementById(`time_kz_${i}`).value = p.timeKz || '00:00:00';
                            document.getElementById(`laps_${i}`).value = p.laps || 0;
                            document.getElementById(`penalty_${i}`).value = p.penalty || 0;
                        }
                    }
                    calculateAll();
                } catch (e) {
                    console.log('Ошибка загрузки данных:', e);
                }
            }
        }
        
        function resetAll() {
            if (confirm('Вы уверены, что хотите сбросить все данные? Все введенные значения будут удалены.')) {
                for (let i = 0; i < participants.length; i++) {
                    document.getElementById(`angle_${i}`).value = 0;
                    document.getElementById(`time_lz_${i}`).value = '00:00:00';
                    document.getElementById(`time_kz_${i}`).value = '00:00:00';
                    document.getElementById(`laps_${i}`).value = 0;
                    document.getElementById(`penalty_${i}`).value = 0;
                    
                    ['score_lz_', 'score_kz_', 'score_track_', 'personal_score_'].forEach(prefix => {
                        document.getElementById(`${prefix}${i}`).textContent = 'ОЖИДАНИЕ';
                        document.getElementById(`${prefix}${i}`).className = 'error-cell';
                    });
                }
                
                for (let i = 0; i < 5; i++) {
                    document.getElementById(`team_score_${i}`).textContent = 'ОЖИДАНИЕ';
                    document.getElementById(`team_score_${i}`).className = 'error-cell';
                }
                
                ['maxAngle', 'maxScoreLz', 'maxScoreKz', 'maxLaps', 'maxScoreTrack'].forEach(id => {
                    document.getElementById(id).textContent = id === 'maxAngle' || id === 'maxLaps' ? '0' : '0.00';
                });
                
                ['minTimeLz', 'minTimeKz'].forEach(id => {
                    document.getElementById(id).textContent = '00:00:00';
                });
                
                document.getElementById('minPenalty').textContent = '0';
                
                localStorage.removeItem(STORAGE_KEYS.DATA);
                alert('Все данные сброшены!');
            }
        }
        
        function fillTestData() {
            const testData = [
                { angle: 51, timeLz: '00:45:00', timeKz: '00:00:00', laps: 0, penalty: 0 },
                { angle: 63, timeLz: '00:53:00', timeKz: '00:00:00', laps: 0, penalty: 0 },
                { angle: 0, timeLz: '00:00:00', timeKz: '00:00:00', laps: 0, penalty: 0 },
                { angle: 0, timeLz: '00:00:00', timeKz: '00:00:00', laps: 0, penalty: 0 },
                { angle: 0, timeLz: '00:00:00', timeKz: '00:00:00', laps: 0, penalty: 0 },
                { angle: 0, timeLz: '00:00:00', timeKz: '00:00:00', laps: 0, penalty: 0 },
                { angle: 45, timeLz: '00:48:30', timeKz: '01:30:45', laps: 10, penalty: 2 },
                { angle: 38, timeLz: '00:52:15', timeKz: '01:35:20', laps: 8, penalty: 1 },
                { angle: 55, timeLz: '00:42:10', timeKz: '01:25:30', laps: 12, penalty: 3 },
                { angle: 42, timeLz: '00:55:40', timeKz: '01:40:15', laps: 9, penalty: 2 }
            ];
            
            for (let i = 0; i < participants.length; i++) {
                const data = testData[i];
                document.getElementById(`angle_${i}`).value = data.angle;
                document.getElementById(`time_lz_${i}`).value = data.timeLz;
                document.getElementById(`time_kz_${i}`).value = data.timeKz;
                document.getElementById(`laps_${i}`).value = data.laps;
                document.getElementById(`penalty_${i}`).value = data.penalty;
            }
            
            calculateAll();
            alert('Тестовые данные загружены!');
        }
        
        function exportToExcel() {
            let csvContent = "data:text/csv;charset=utf-8,";
            const headers = [
                "Команда", "Участник", "Угол (Литофф)", "Время ЛЗ (ММ:СС:МС)", "Баллы ЛЗ",
                "Время КЗ (ММ:СС:МС)", "Баллы КЗ", "Круги (Трасса)", "Штраф (Трасса)",
                "Баллы Трассы", "Баллы ЛЗ (личный)", "Баллы КЗ (командный)"
            ];
            
            csvContent += headers.join(";") + "\n";
            
            for (let i = 0; i < participants.length; i++) {
                const participant = participants[i];
                const isFirstInTeam = i === 0 || participants[i-1].team !== participant.team;
                
                let teamScore = "ОЖИДАНИЕ";
                if (isFirstInTeam) {
                    teamScore = document.getElementById(`team_score_${participant.teamIndex}`).textContent;
                }
                
                const row = [
                    isFirstInTeam ? `"${participant.team}"` : "",
                    participant.name,
                    document.getElementById(`angle_${i}`).value,
                    document.getElementById(`time_lz_${i}`).value,
                    document.getElementById(`score_lz_${i}`).textContent,
                    document.getElementById(`time_kz_${i}`).value,
                    document.getElementById(`score_kz_${i}`).textContent,
                    document.getElementById(`laps_${i}`).value,
                    document.getElementById(`penalty_${i}`).value,
                    document.getElementById(`score_track_${i}`).textContent,
                    document.getElementById(`personal_score_${i}`).textContent,
                    isFirstInTeam ? teamScore : ""
                ];
                
                csvContent += row.join(";") + "\n";
            }
            
            csvContent += "\n;;;Статистика;;;;;;;;\n";
            csvContent += `Максимальный угол;${document.getElementById('maxAngle').textContent};;;;;;;;\n`;
            csvContent += `Минимальное время ЛЗ;${document.getElementById('minTimeLz').textContent};;;;;;;;\n`;
            csvContent += `Максимальные баллы ЛЗ;${document.getElementById('maxScoreLz').textContent};;;;;;;;\n`;
            csvContent += `Минимальное время КЗ;${document.getElementById('minTimeKz').textContent};;;;;;;;\n`;
            csvContent += `Максимальные баллы КЗ;${document.getElementById('maxScoreKz').textContent};;;;;;;;\n`;
            csvContent += `Максимальные круги;${document.getElementById('maxLaps').textContent};;;;;;;;\n`;
            csvContent += `Максимальные баллы трассы;${document.getElementById('maxScoreTrack').textContent};;;;;;;;`;
            
            const encodedUri = encodeURI(csvContent);
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            link.setAttribute("download", `турнир_вихрь_${new Date().toISOString().slice(0,10)}.csv`);
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            alert('Таблица экспортирована в CSV файл!');
        }
    </script>
</body>
</html>
