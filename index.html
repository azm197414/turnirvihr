<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Турнирная таблица клуба "Вихрь"</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f5f5f5;
            padding: 20px;
            margin: 0;
        }
        .container {
            max-width: 95vw;
            margin: 0 auto;
            overflow-x: auto;
        }
        .tournament-table {
            border-collapse: collapse;
            background-color: white;
            box-shadow: 0 0 10px rgba(0,0,0,0.1);
            margin-bottom: 20px;
            font-size: 0.85em;
            min-width: 1400px;
            border: 2px solid #2c3e50;
        }
        .tournament-table th, .tournament-table td {
            border: 2px solid #95a5a6;
            padding: 6px 8px;
            text-align: center;
            vertical-align: middle;
            min-width: 70px;
        }
        .tournament-table th {
            background-color: #2c3e50;
            color: white;
            font-weight: bold;
            border: 2px solid #34495e;
        }
        .title-row {
            background-color: #2c3e50;
            color: white;
            font-size: 1.1em;
            font-weight: bold;
            border: 2px solid #2c3e50;
        }
        .input-cell {
            background-color: #fff;
        }
        .input-cell input {
            width: 90%;
            padding: 4px;
            border: 1px solid #ddd;
            border-radius: 3px;
            text-align: center;
            font-size: 0.9em;
        }
        .result-cell {
            background-color: #e8f4fd;
            font-weight: bold;
            color: #2c3e50;
        }
        .team-header {
            background-color: #ecf0f1;
            font-weight: bold;
        }
        .participant-row {
            background-color: #f8f9fa;
        }
        .controls {
            background-color: #fff;
            padding: 15px;
            border-radius: 5px;
            box-shadow: 0 0 5px rgba(0,0,0,0.1);
            margin-bottom: 20px;
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }
        .controls button {
            background-color: #3498db;
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 3px;
            cursor: pointer;
            font-size: 0.9em;
            font-weight: bold;
        }
        .controls button:hover {
            background-color: #2980b9;
        }
        .controls button.reset {
            background-color: #e74c3c;
        }
        .controls button.reset:hover {
            background-color: #c0392b;
        }
        .controls button.test {
            background-color: #2ecc71;
        }
        .controls button.test:hover {
            background-color: #27ae60;
        }
        .controls button.export {
            background-color: #9b59b6;
        }
        .controls button.export:hover {
            background-color: #8e44ad;
        }
        .notes {
            font-size: 0.9em;
            color: #7f8c8d;
            margin-top: 10px;
            padding: 10px;
            background-color: #ecf0f1;
            border-left: 4px solid #3498db;
        }
        .time-input {
            font-family: monospace;
            font-size: 0.85em;
        }
        .calculated-cell {
            background-color: #e8f6f3;
            font-weight: bold;
        }
        .personal-score {
            background-color: #d5f4e6;
            font-weight: bold;
        }
        .team-score {
            background-color: #fef9e7;
            font-weight: bold;
            font-size: 1.1em;
        }
        .error-cell {
            background-color: #fadbd8;
            color: #c0392b;
            font-weight: bold;
        }
        .formula-note {
            font-size: 0.75em;
            color: #7f8c8d;
            font-style: italic;
        }
        .participant-name {
            white-space: nowrap;
            text-align: left;
            padding-left: 10px;
            font-weight: bold;
        }
        .team-name {
            font-weight: bold;
            font-size: 1em;
        }
        .header-name {
            font-weight: bold;
        }
        .main-title {
            background-color: #2c3e50;
            color: white;
            padding: 15px;
            text-align: center;
            font-size: 1.3em;
            font-weight: bold;
            margin-bottom: 20px;
            border-radius: 5px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        .section-divider {
            border-right: 3px solid #3498db !important;
        }
        .category-header {
            background-color: #34495e;
            font-weight: bold;
        }
        .max-min-cell {
            background-color: #d6dbdf;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="main-title">
            ТАБЛИЦА БОЛЬШОГО ЗИМНЕГО ТУРНИРА КЛУБА ПИЛОТОВ БПЛА "ВИХРЬ"
        </div>
        
        <div class="controls">
            <button onclick="calculateAll()">Пересчитать все</button>
            <button onclick="resetAll()" class="reset">Сбросить все данные</button>
            <button onclick="fillTestData()" class="test">Заполнить тестовые данные</button>
            <button onclick="exportToExcel()" class="export">Экспорт в CSV</button>
        </div>
        
        <table class="tournament-table" id="tournamentTable">
            <!-- Основные заголовки -->
            <tr>
                <th rowspan="3" class="header-name">Команда</th>
                <th rowspan="3" class="header-name">Участник</th>
                <th colspan="3" class="header-name category-header">Литофф</th>
                <th colspan="2" class="header-name category-header">Квадросим</th>
                <th colspan="3" class="header-name category-header">Трасса</th>
                <th rowspan="3" class="header-name">Баллы ЛЗ</th>
                <th rowspan="3" class="header-name">Баллы КЗ</th>
            </tr>
            
            <tr class="category-header">
                <!-- Литофф подзаголовки -->
                <th class="header-name">Угол</th>
                <th class="header-name">Время (ММ:СС:МС)</th>
                <th class="header-name">Баллы</th>
                <!-- Квадросим подзаголовки -->
                <th class="header-name">Время (ММ:СС:МС)</th>
                <th class="header-name">Баллы</th>
                <!-- Трасса подзаголовки -->
                <th class="header-name">Кол-во кругов</th>
                <th class="header-name">Штраф</th>
                <th class="header-name">Баллы</th>
            </tr>
            
            <tr class="max-min-cell">
                <!-- Литофф формулы для максимума/минимума -->
                <td>Максимум<br><span id="maxAngle">0</span></td>
                <td>Минимум<br><span id="minTimeLz">00:00:00</span></td>
                <td>Максимум<br><span id="maxScoreLz">0.00</span></td>
                <!-- Квадросим формулы для минимума -->
                <td>Минимум<br><span id="minTimeKz">00:00:00</span></td>
                <td>Максимум<br><span id="maxScoreKz">0.00</span></td>
                <!-- Трасса формулы для максимума/минимума -->
                <td>Максимум<br><span id="maxLaps">0</span></td>
                <td>Минимум<br><span id="minPenalty">0</span></td>
                <td>Максимум<br><span id="maxScoreTrack">0.00</span></td>
                <!-- Пустые для выравнивания -->
                <td></td>
                <td></td>
            </tr>
            
            <!-- Данные участников будут заполняться JavaScript -->
        </table>
        
        <div class="notes">
            <p><strong>Формулы расчетов:</strong></p>
            <ul>
                <li><strong>Баллы Литофф:</strong> = (Угол/МАКС_Угол * 70) + (МИН_Время_ЛЗ/Время_ЛЗ * 30)</li>
                <li><strong>Баллы Квадросим:</strong> = (МИН_Время_КЗ * 100) / Время_КЗ</li>
                <li><strong>Баллы Трассы:</strong> = (Круги/МАКС_Круги * 100) - Штраф</li>
                <li><strong>Баллы ЛЗ (личный зачет):</strong> = Баллы_Литофф + Баллы_Квадросим + Баллы_Трассы</li>
                <li><strong>Баллы КЗ (командный зачет):</strong> = Сумма Баллов_ЛЗ обоих участников команды (одна ячейка на команду)</li>
                <li><strong>ОЖИДАНИЕ:</strong> показывается при отсутствии данных или делении на ноль</li>
            </ul>
        </div>
    </div>

    <script>
        // Данные участников
        const participants = [
            // Команда "Интенсив"
            { team: "Интенсив", name: "Ксения Л.", id: 1, teamIndex: 0 },
            { team: "Интенсив", name: "Святослав Е.", id: 2, teamIndex: 0 },
            // Команда "Прорыв"
            { team: "Прорыв", name: "Никита У.", id: 3, teamIndex: 1 },
            { team: "Прорыв", name: "Варя А.", id: 4, teamIndex: 1 },
            // Команда "Альфа"
            { team: "Альфа", name: "Дмитрий В.", id: 5, teamIndex: 2 },
            { team: "Альфа", name: "Иван Ф.", id: 6, teamIndex: 2 },
            // Команда "Стабильность"
            { team: "Стабильность", name: "Савелий С.", id: 7, teamIndex: 3 },
            { team: "Стабильность", name: "Богдан Е.", id: 8, teamIndex: 3 },
            // Команда "Мотивация"
            { team: "Мотивация", name: "Артем П.", id: 9, teamIndex: 4 },
            { team: "Мотивация", name: "Данила Л.", id: 10, teamIndex: 4 }
        ];

        // Создаем таблицу с участниками
        function createTable() {
            const table = document.getElementById('tournamentTable');
            
            // Удаляем существующие строки с данными (кроме заголовков)
            while (table.rows.length > 3) {
                table.deleteRow(3);
            }
            
            // Создаем массив для хранения индексов первых участников команд
            const firstParticipantIndexes = [];
            
            // Добавляем строки для каждого участника
            participants.forEach((participant, index) => {
                const row = table.insertRow();
                const isFirstInTeam = index === 0 || participants[index-1].team !== participant.team;
                
                if (isFirstInTeam) {
                    row.className = 'team-header';
                    firstParticipantIndexes.push(index); // Сохраняем индекс первого участника команды
                } else {
                    row.className = 'participant-row';
                }
                
                // Заполняем ячейки
                if (isFirstInTeam) {
                    row.innerHTML = `
                        <td rowspan="2" class="team-name">"${participant.team}"</td>
                        <td class="participant-name">${participant.name}</td>
                        
                        <!-- Литофф: Угол -->
                        <td class="input-cell"><input type="number" id="angle_${index}" min="0" max="90" value="0" step="1" placeholder="0-90°"></td>
                        
                        <!-- Литофф: Время с миллисекундами -->
                        <td class="input-cell">
                            <input type="text" id="time_lz_${index}" class="time-input" placeholder="ММ:СС:МС" value="00:00:00">
                        </td>
                        
                        <!-- Литофф: Баллы -->
                        <td class="result-cell" id="score_lz_${index}">ОЖИДАНИЕ</td>
                        
                        <!-- Квадросим: Время с миллисекундами -->
                        <td class="input-cell">
                            <input type="text" id="time_kz_${index}" class="time-input" placeholder="ММ:СС:МС" value="00:00:00">
                        </td>
                        
                        <!-- Квадросим: Баллы -->
                        <td class="result-cell" id="score_kz_${index}">ОЖИДАНИЕ</td>
                        
                        <!-- Трасса: Круги -->
                        <td class="input-cell"><input type="number" id="laps_${index}" min="0" value="0" placeholder="0+"></td>
                        
                        <!-- Трасса: Штраф -->
                        <td class="input-cell"><input type="number" id="penalty_${index}" min="0" value="0" placeholder="0+"></td>
                        
                        <!-- Трасса: Баллы -->
                        <td class="result-cell" id="score_track_${index}">ОЖИДАНИЕ</td>
                        
                        <!-- Баллы ЛЗ (личный зачет) -->
                        <td class="personal-score" id="personal_score_${index}">ОЖИДАНИЕ</td>
                        
                        <!-- Баллы КЗ (командный зачет) - только для первого участника -->
                        <td rowspan="2" class="team-score" id="team_score_${participant.teamIndex}">ОЖИДАНИЕ</td>
                    `;
                } else {
                    row.innerHTML = `
                        <td class="participant-name">${participant.name}</td>
                        
                        <!-- Литофф: Угол -->
                        <td class="input-cell"><input type="number" id="angle_${index}" min="0" max="90" value="0" step="1" placeholder="0-90°"></td>
                        
                        <!-- Литофф: Время с миллисекундами -->
                        <td class="input-cell">
                            <input type="text" id="time_lz_${index}" class="time-input" placeholder="ММ:СС:МС" value="00:00:00">
                        </td>
                        
                        <!-- Литофф: Баллы -->
                        <td class="result-cell" id="score_lz_${index}">ОЖИДАНИЕ</td>
                        
                        <!-- Квадросим: Время с миллисекундами -->
                        <td class="input-cell">
                            <input type="text" id="time_kz_${index}" class="time-input" placeholder="ММ:СС:МС" value="00:00:00">
                        </td>
                        
                        <!-- Квадросим: Баллы -->
                        <td class="result-cell" id="score_kz_${index}">ОЖИДАНИЕ</td>
                        
                        <!-- Трасса: Круги -->
                        <td class="input-cell"><input type="number" id="laps_${index}" min="0" value="0" placeholder="0+"></td>
                        
                        <!-- Трасса: Штраф -->
                        <td class="input-cell"><input type="number" id="penalty_${index}" min="0" value="0" placeholder="0+"></td>
                        
                        <!-- Трасса: Баллы -->
                        <td class="result-cell" id="score_track_${index}">ОЖИДАНИЕ</td>
                        
                        <!-- Баллы ЛЗ (личный зачет) -->
                        <td class="personal-score" id="personal_score_${index}">ОЖИДАНИЕ</td>
                        <!-- Баллы КЗ (командный зачет) - для второго участника ячейка объединена -->
                    `;
                }
            });
            
            // Сохраняем индексы первых участников команд для дальнейшего использования
            window.firstParticipantIndexes = firstParticipantIndexes;
            
            // Добавляем обработчики событий
            addInputEventListeners();
        }
        
        // Добавляем обработчики событий для полей ввода
        function addInputEventListeners() {
            for (let i = 0; i < participants.length; i++) {
                // Добавляем обработчики для всех полей ввода
                const inputs = [
                    `angle_${i}`,
                    `time_lz_${i}`,
                    `time_kz_${i}`,
                    `laps_${i}`,
                    `penalty_${i}`
                ];
                
                inputs.forEach(id => {
                    const input = document.getElementById(id);
                    if (input) {
                        input.addEventListener('input', () => {
                            calculateAll();
                        });
                        
                        // Для полей времени добавляем обработчик blur для форматирования
                        if (id.startsWith('time_')) {
                            input.addEventListener('blur', function() {
                                formatTimeInput(this);
                            });
                        }
                    }
                });
            }
        }
        
        // Форматирование ввода времени
        function formatTimeInput(input) {
            let value = input.value.trim();
            
            if (!value) {
                input.value = '00:00:00';
                return;
            }
            
            // Удаляем все нецифровые символы
            value = value.replace(/[^\d]/g, '');
            
            // Добавляем ведущие нули
            while (value.length < 6) {
                value = '0' + value;
            }
            
            // Ограничиваем до 6 цифр (ММССМС)
            value = value.substring(0, 6);
            
            // Форматируем как ММ:СС:МС
            const minutes = value.substring(0, 2);
            const seconds = value.substring(2, 4);
            const milliseconds = value.substring(4, 6);
            
            input.value = `${minutes}:${seconds}:${milliseconds}`;
        }
        
        // Преобразование времени с миллисекундами в секунды (с десятыми)
        function timeToSeconds(timeStr) {
            if (!timeStr || timeStr === '00:00:00') return 0;
            
            // Формат: ММ:СС:МС (миллисекунды как сотые доли секунды)
            const parts = timeStr.split(':');
            if (parts.length !== 3) return 0;
            
            const minutes = parseInt(parts[0]) || 0;
            const seconds = parseInt(parts[1]) || 0;
            const milliseconds = parseInt(parts[2]) || 0; // 00-99
            
            if (isNaN(minutes) || isNaN(seconds) || isNaN(milliseconds)) return 0;
            
            // Преобразуем миллисекунды в десятые доли секунды
            const secondsWithMs = seconds + (milliseconds / 100);
            
            return minutes * 60 + secondsWithMs;
        }
        
        // Преобразование секунд в строку времени с миллисекундами
        function secondsToTime(seconds) {
            if (seconds <= 0) return '00:00:00';
            
            const totalSeconds = seconds;
            const mins = Math.floor(totalSeconds / 60);
            const secs = Math.floor(totalSeconds % 60);
            const ms = Math.round((totalSeconds - Math.floor(totalSeconds)) * 100);
            
            return `${mins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}:${ms.toString().padStart(2, '0')}`;
        }
        
        // Расчет всех результатов
        function calculateAll() {
            // Собираем все данные участников
            const participantsData = [];
            
            for (let i = 0; i < participants.length; i++) {
                const angle = parseFloat(document.getElementById(`angle_${i}`).value) || 0;
                const timeLz = timeToSeconds(document.getElementById(`time_lz_${i}`).value);
                const timeKz = timeToSeconds(document.getElementById(`time_kz_${i}`).value);
                const laps = parseFloat(document.getElementById(`laps_${i}`).value) || 0;
                const penalty = parseFloat(document.getElementById(`penalty_${i}`).value) || 0;
                
                participantsData.push({
                    index: i,
                    angle: angle,
                    timeLz: timeLz,
                    timeKz: timeKz,
                    laps: laps,
                    penalty: penalty,
                    team: participants[i].team,
                    teamIndex: participants[i].teamIndex
                });
            }
            
            // Рассчитываем максимумы и минимумы
            // Максимальный угол (только положительные значения)
            const maxAngle = Math.max(...participantsData
                .filter(p => p.angle > 0)
                .map(p => p.angle));
            
            // Минимальное время ЛЗ (только положительные значения)
            const minTimeLz = Math.min(...participantsData
                .filter(p => p.timeLz > 0)
                .map(p => p.timeLz));
            
            // Минимальное время КЗ (только положительные значения)
            const minTimeKz = Math.min(...participantsData
                .filter(p => p.timeKz > 0)
                .map(p => p.timeKz));
            
            // Максимальное количество кругов (только положительные значения)
            const maxLaps = Math.max(...participantsData
                .filter(p => p.laps > 0)
                .map(p => p.laps));
            
            // Минимальный штраф (только положительные значения)
            const minPenalty = Math.min(...participantsData
                .filter(p => p.penalty > 0)
                .map(p => p.penalty));
            
            // Обновляем заголовки с максимумами/минимумами
            document.getElementById('maxAngle').textContent = maxAngle > 0 ? maxAngle : '0';
            document.getElementById('minTimeLz').textContent = minTimeLz > 0 ? secondsToTime(minTimeLz) : '00:00:00';
            document.getElementById('minTimeKz').textContent = minTimeKz > 0 ? secondsToTime(minTimeKz) : '00:00:00';
            document.getElementById('maxLaps').textContent = maxLaps > 0 ? maxLaps : '0';
            document.getElementById('minPenalty').textContent = minPenalty > 0 ? minPenalty : '0';
            
            // Рассчитываем баллы для каждого участника
            let maxScoreLz = 0;
            let maxScoreKz = 0;
            let maxScoreTrack = 0;
            
            participantsData.forEach(data => {
                const i = data.index;
                
                // 1. Баллы Литофф
                let scoreLz = "ОЖИДАНИЕ";
                if (maxAngle > 0 && data.angle > 0 && minTimeLz > 0 && data.timeLz > 0) {
                    const calculated = ((data.angle / maxAngle) * 70) + ((minTimeLz / data.timeLz) * 30);
                    scoreLz = calculated.toFixed(2);
                    maxScoreLz = Math.max(maxScoreLz, calculated);
                }
                
                // 2. Баллы Квадросим
                let scoreKz = "ОЖИДАНИЕ";
                if (minTimeKz > 0 && data.timeKz > 0) {
                    const calculated = (minTimeKz * 100) / data.timeKz;
                    scoreKz = calculated.toFixed(2);
                    maxScoreKz = Math.max(maxScoreKz, calculated);
                }
                
                // 3. Баллы Трассы
                let scoreTrack = "ОЖИДАНИЕ";
                if (maxLaps > 0 && data.laps > 0) {
                    const calculated = ((data.laps / maxLaps) * 100) - data.penalty;
                    scoreTrack = calculated > 0 ? calculated.toFixed(2) : "0.00";
                    maxScoreTrack = Math.max(maxScoreTrack, calculated > 0 ? calculated : 0);
                }
                
                // 4. Баллы ЛЗ (личный зачет)
                let personalScore = "ОЖИДАНИЕ";
                if (scoreLz !== "ОЖИДАНИЕ" && scoreKz !== "ОЖИДАНИЕ" && scoreTrack !== "ОЖИДАНИЕ") {
                    const calculated = parseFloat(scoreLz) + parseFloat(scoreKz) + parseFloat(scoreTrack);
                    personalScore = calculated.toFixed(2);
                }
                
                // Сохраняем результаты
                data.scoreLz = scoreLz === "ОЖИДАНИЕ" ? 0 : parseFloat(scoreLz);
                data.scoreKz = scoreKz === "ОЖИДАНИЕ" ? 0 : parseFloat(scoreKz);
                data.scoreTrack = scoreTrack === "ОЖИДАНИЕ" ? 0 : parseFloat(scoreTrack);
                data.personalScore = personalScore === "ОЖИДАНИЕ" ? 0 : parseFloat(personalScore);
                
                // Обновляем ячейки
                document.getElementById(`score_lz_${i}`).textContent = scoreLz;
                document.getElementById(`score_lz_${i}`).className = scoreLz === "ОЖИДАНИЕ" ? "error-cell" : "result-cell";
                
                document.getElementById(`score_kz_${i}`).textContent = scoreKz;
                document.getElementById(`score_kz_${i}`).className = scoreKz === "ОЖИДАНИЕ" ? "error-cell" : "result-cell";
                
                document.getElementById(`score_track_${i}`).textContent = scoreTrack;
                document.getElementById(`score_track_${i}`).className = scoreTrack === "ОЖИДАНИЕ" ? "error-cell" : "result-cell";
                
                document.getElementById(`personal_score_${i}`).textContent = personalScore;
                document.getElementById(`personal_score_${i}`).className = personalScore === "ОЖИДАНИЕ" ? "error-cell" : "personal-score";
            });
            
            // Обновляем оставшиеся максимумы в заголовках
            document.getElementById('maxScoreLz').textContent = maxScoreLz.toFixed(2);
            document.getElementById('maxScoreKz').textContent = maxScoreKz.toFixed(2);
            document.getElementById('maxScoreTrack').textContent = maxScoreTrack.toFixed(2);
            
            // Рассчитываем командные баллы (КЗ) - сумма баллов обоих участников команды
            const teamScores = {};
            
            // Суммируем личные баллы по командам
            participantsData.forEach(data => {
                if (!teamScores[data.teamIndex]) {
                    teamScores[data.teamIndex] = 0;
                }
                teamScores[data.teamIndex] += data.personalScore;
            });
            
            // Обновляем командные баллы (одна ячейка на команду)
            for (const [teamIndex, teamScore] of Object.entries(teamScores)) {
                document.getElementById(`team_score_${teamIndex}`).textContent = teamScore.toFixed(2);
                document.getElementById(`team_score_${teamIndex}`).className = "team-score";
            }
            
            // Для команд без данных тоже обновляем
            for (let i = 0; i < 5; i++) {
                if (!teamScores[i]) {
                    document.getElementById(`team_score_${i}`).textContent = "ОЖИДАНИЕ";
                    document.getElementById(`team_score_${i}`).className = "error-cell";
                }
            }
        }
        
        // Сброс всех данных
        function resetAll() {
            if (confirm('Вы уверены, что хотите сбросить все данные? Все введенные значения будут удалены.')) {
                for (let i = 0; i < participants.length; i++) {
                    // Сбрасываем поля ввода
                    document.getElementById(`angle_${i}`).value = 0;
                    document.getElementById(`time_lz_${i}`).value = '00:00:00';
                    document.getElementById(`time_kz_${i}`).value = '00:00:00';
                    document.getElementById(`laps_${i}`).value = 0;
                    document.getElementById(`penalty_${i}`).value = 0;
                    
                    // Сбрасываем результаты
                    document.getElementById(`score_lz_${i}`).textContent = 'ОЖИДАНИЕ';
                    document.getElementById(`score_lz_${i}`).className = 'error-cell';
                    
                    document.getElementById(`score_kz_${i}`).textContent = 'ОЖИДАНИЕ';
                    document.getElementById(`score_kz_${i}`).className = 'error-cell';
                    
                    document.getElementById(`score_track_${i}`).textContent = 'ОЖИДАНИЕ';
                    document.getElementById(`score_track_${i}`).className = 'error-cell';
                    
                    document.getElementById(`personal_score_${i}`).textContent = 'ОЖИДАНИЕ';
                    document.getElementById(`personal_score_${i}`).className = 'error-cell';
                }
                
                // Сбрасываем командные баллы
                for (let i = 0; i < 5; i++) {
                    document.getElementById(`team_score_${i}`).textContent = 'ОЖИДАНИЕ';
                    document.getElementById(`team_score_${i}`).className = 'error-cell';
                }
                
                // Сбрасываем заголовки
                document.getElementById('maxAngle').textContent = '0';
                document.getElementById('minTimeLz').textContent = '00:00:00';
                document.getElementById('maxScoreLz').textContent = '0.00';
                document.getElementById('minTimeKz').textContent = '00:00:00';
                document.getElementById('maxScoreKz').textContent = '0.00';
                document.getElementById('maxLaps').textContent = '0';
                document.getElementById('minPenalty').textContent = '0';
                document.getElementById('maxScoreTrack').textContent = '0.00';
                
                alert('Все данные сброшены!');
            }
        }
        
        // Заполнение тестовыми данными (по примеру из скриншота)
        function fillTestData() {
            // Тестовые данные как в скриншоте и Excel
            const testData = [
                // Интенсив - Ксения Л. (данные из скриншота)
                { angle: 51, timeLz: '00:45:00', timeKz: '00:00:00', laps: 0, penalty: 0 },
                // Интенсив - Святослав Е. (данные из скриншота)
                { angle: 63, timeLz: '00:53:00', timeKz: '00:00:00', laps: 0, penalty: 0 },
                // Прорыв - Никита У. (без данных)
                { angle: 0, timeLz: '00:00:00', timeKz: '00:00:00', laps: 0, penalty: 0 },
                // Прорыв - Варя А. (без данных)
                { angle: 0, timeLz: '00:00:00', timeKz: '00:00:00', laps: 0, penalty: 0 },
                // Альфа - Дмитрий В. (без данных)
                { angle: 0, timeLz: '00:00:00', timeKz: '00:00:00', laps: 0, penalty: 0 },
                // Альфа - Иван Ф. (без данных)
                { angle: 0, timeLz: '00:00:00', timeKz: '00:00:00', laps: 0, penalty: 0 },
                // Стабильность - Савелий С. (тестовые данные)
                { angle: 45, timeLz: '00:48:30', timeKz: '01:30:45', laps: 10, penalty: 2 },
                // Стабильность - Богдан Е. (тестовые данные)
                { angle: 38, timeLz: '00:52:15', timeKz: '01:35:20', laps: 8, penalty: 1 },
                // Мотивация - Артем П. (тестовые данные)
                { angle: 55, timeLz: '00:42:10', timeKz: '01:25:30', laps: 12, penalty: 3 },
                // Мотивация - Данила Л. (тестовые данные)
                { angle: 42, timeLz: '00:55:40', timeKz: '01:40:15', laps: 9, penalty: 2 }
            ];
            
            for (let i = 0; i < participants.length; i++) {
                const data = testData[i];
                document.getElementById(`angle_${i}`).value = data.angle;
                document.getElementById(`time_lz_${i}`).value = data.timeLz;
                document.getElementById(`time_kz_${i}`).value = data.timeKz;
                document.getElementById(`laps_${i}`).value = data.laps;
                document.getElementById(`penalty_${i}`).value = data.penalty;
            }
            
            calculateAll();
            alert('Тестовые данные загружены! Проверьте расчеты для команды "Интенсив" - должны быть баллы как в скриншоте.');
        }
        
        // Экспорт в CSV (аналог Excel)
        function exportToExcel() {
            let csvContent = "data:text/csv;charset=utf-8,";
            
            // Заголовки
            const headers = [
                "Команда",
                "Участник",
                "Угол (Литофф)",
                "Время ЛЗ (ММ:СС:МС)",
                "Баллы ЛЗ",
                "Время КЗ (ММ:СС:МС)",
                "Баллы КЗ",
                "Круги (Трасса)",
                "Штраф (Трасса)",
                "Баллы Трассы",
                "Баллы ЛЗ (личный)",
                "Баллы КЗ (командный)"
            ];
            
            csvContent += headers.join(";") + "\n";
            
            // Данные участников
            for (let i = 0; i < participants.length; i++) {
                const participant = participants[i];
                const isFirstInTeam = i === 0 || participants[i-1].team !== participant.team;
                
                // Для командного зачета берем значение только для первого участника
                let teamScore = "ОЖИДАНИЕ";
                if (isFirstInTeam) {
                    teamScore = document.getElementById(`team_score_${participant.teamIndex}`).textContent;
                }
                
                const row = [
                    isFirstInTeam ? `"${participant.team}"` : "",
                    participant.name,
                    document.getElementById(`angle_${i}`).value,
                    document.getElementById(`time_lz_${i}`).value,
                    document.getElementById(`score_lz_${i}`).textContent,
                    document.getElementById(`time_kz_${i}`).value,
                    document.getElementById(`score_kz_${i}`).textContent,
                    document.getElementById(`laps_${i}`).value,
                    document.getElementById(`penalty_${i}`).value,
                    document.getElementById(`score_track_${i}`).textContent,
                    document.getElementById(`personal_score_${i}`).textContent,
                    isFirstInTeam ? teamScore : "" // Командный зачет только для первого участника
                ];
                
                csvContent += row.join(";") + "\n";
            }
            
            // Добавляем статистику
            csvContent += "\n;;;Статистика;;;;;;;;\n";
            csvContent += `Максимальный угол;${document.getElementById('maxAngle').textContent};;;;;;;;\n`;
            csvContent += `Минимальное время ЛЗ;${document.getElementById('minTimeLz').textContent};;;;;;;;\n`;
            csvContent += `Максимальные баллы ЛЗ;${document.getElementById('maxScoreLz').textContent};;;;;;;;\n`;
            csvContent += `Минимальное время КЗ;${document.getElementById('minTimeKz').textContent};;;;;;;;\n`;
            csvContent += `Максимальные баллы КЗ;${document.getElementById('maxScoreKz').textContent};;;;;;;;\n`;
            csvContent += `Максимальные круги;${document.getElementById('maxLaps').textContent};;;;;;;;\n`;
            csvContent += `Максимальные баллы трассы;${document.getElementById('maxScoreTrack').textContent};;;;;;;;`;
            
            const encodedUri = encodeURI(csvContent);
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            link.setAttribute("download", "турнирная_таблица_вихрь.csv");
            document.body.appendChild(link);
            
            link.click();
            document.body.removeChild(link);
            
            alert('Таблица экспортирована в файл "турнирная_таблица_вихрь.csv"');
        }
        
        // Инициализация при загрузке страницы
        document.addEventListener('DOMContentLoaded', function() {
            createTable();
            calculateAll(); // Первоначальный расчет
        });
    </script>
</body>
</html>
